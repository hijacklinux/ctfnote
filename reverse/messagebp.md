---
layout: default
---
# ![](../img/hj.jpg)逆向工程-PC逆向-消息断点和条件断点

## ![](../img/github18.png)消息断点
### 总体思路方法
```
1、点运行程序（弹出程序界面，不理它）--点查看菜单--窗口（点右键刷新一下）--单击“CHECK”那一行--点右键，选消息断点--选“202 WM_LBUTTONUP”--确定

2、在程序中输入假码 ：
name:666666,serial：7777777
--点check，被断下了

3、点查看菜单--内存--点击.text那一行--按F2设一次性断点，运行就在代码段断下了
```
>小贱提示：这种下段功能还是有限的，因为如果要断下程序菜单里的按钮，就没办法了，需要下条件记录断点

### button的定位
(断下后可使用条件断点方法返回程序领空)
>首先:
>
>1 od 下运行程序，F12 暂停；
>
>2 View菜单中选击Windows项，在打开的窗口中可以从Title栏看到目标按钮，从而找到它的Handle(xxxxxxxx) ;
>
>对不同平台生成的程序，分别处理

#### VB, Delphi, CBuilder 程序
```
3 在CallWindowProcA入口下条件断点: [esp+8]==xxxxxxxx && [esp+0c]==202；
4 F9继续程序，点击目标按钮，程序中断；
5 Alt+F4，在代码段（.text）上下访问断点；
6 F9执行程序，程序中断,
   1). VB程序中断在下面代码
     PUSH DWORD PTR DS:[EAX+EBX]              ; yyyyyyy
     上面[EAX+EBX]的值（yyyyyy）就是我们要找的位置。

   2). Delphi, CBuilder 的程序
     程序直接断在我们要找的位置。

下面是简便定位：
bp CallWindowProcA [esp+8]==00106AE && [esp+0c]==202
====>
bp CallWindowProcA [esp+8]==00106AE && MSG==202
```
#### VC程序
```
又分MFC和Win32两种情况，二者相同之处：
3 在IsDialogMessageW入口下条件断点: [[esp+8]]==xxxxxxxx && [[esp+8]+4]==202
4 F9继续程序，点击目标按钮，程序中断；
5 Alt+F4，在代码段上下访问断点；
6 F9执行程序，程序中断, 注意这里虽然中断在code段，但却不是处理Button点击事件的代码处
  这时：
  对Win32程序，只需要按几下F7，当回到User32.dll领空后再重复一次第 5、6步就可以了；
  而对于MFC程序，我们不得不多次重复这样的操作：单步回到MFC领空，再第 5、6步。好在已经看到大陆啦！
下面是简便定位：
bp IsDialogMessageW [[esp+8]]==00106AE && [[esp+8]+4]==202
====>
bp IsDialogMessageW [[esp+8]]==00106AE && MSG==202
```
## ![](../img/github19.png)条件断点(Shift+F2)
>如果满足设置的条件,那么程序就会中断下来,如果不满足条件的话,就和没有设置CC断点差不多。
>
>选中目标指令行，Shift+F2

### 情况一：有时候一切换到程序就断下来，注意看hwnd
```
0013F960   7DBF73F4  /CALL 到 GetWindowTextW 来自 COMCTL32.7DBF73EE
0013F964   000C00CA  |hWnd = 000C00CA ('用户名：',class='Static',parent=000E00AE)
0013F968   00269050  |Buffer = 00269050
0013F96C   00000005  \Count = 5
去ALT+W,找想要的控件edit句柄如0x36011E
在api处shift+f2下条件断点[esp+4]==0x36011E
```
### 情况二：返回点是在krnln模块中，并不是EXE当中
```
这时在情况一基础上需要配合RUN跟踪
条件断点断下后，Alt+E,看看主程序地址范围
Ctrl+T,勾选EIP范围，就填主程序范围，然后Ctrl+F11或F12就到达程序领空了
```
>小贱提示：
>
>使用上面讲的API断点+条件断点+RUN跟踪，就已经可以对几乎所有未加密的程序，快速地定位到关键代码


## ![](../img/github20.png)条件记录断点(Shift+F4)
>和条件断点差不多,区别在于可以记录下设置的条件的精确值

### 具体方法
```
1、Ctrl+G:MessageBoxA,
2、在该行Shift+F4
如果不想程序中断,那么(中断程序)这个单选按钮选择Never即可。
3、单击工具栏中【L】按钮打开日志窗口，右键clear
4、F9键运行程序
```
>小贱提示：
>
>如果程序中有大约100处调用了该API函数,你可以指定相应的条件,比如说返回地址。
>
>设置条件为[ESP] == 40137D,那么这100个函数调用中只有返回地址为40137D的会被记录下来。

### 关于Shift F4对话框的各项解释
```
1）第一行”条件“：要断下的条件或触发记录的条件
2）”说明“=”表达“
第一行的条件为真时，会记录我们在”表达“里填的内容
举例：
条件填入[esp+4]==68
说明填入”密码“
表达填入eax
那么就意味着，当条件[esp+4]==68时，日志里面会记录：密码=13579（假设此时eax的值是13579）
3）”解码表达式“
意思是对2）步的“表达”的值进行二次处理，例如eax=202，如果此时选择“消息代码”，则日志里就变成了
密码=202 WM_LBUTTONUP
4）
暂停程序：看你想不想暂停了
记录表达式的值：一般选择“条件满足”
记录函数参数：如果只想记录参数，那么前两个都选永不
```





__原创文章，转载请注明转载自[http://www.8pwn.com](http://www.8pwn.com)__

[返回上一层](./reverse)
